<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jarvis Log Viewer</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f1117;
    --bg-card: #1a1d28;
    --bg-card-hover: #21252f;
    --bg-sidebar: #141620;
    --border: #2a2d3a;
    --text: #e2e8f0;
    --text-dim: #8892a4;
    --text-muted: #5a6478;
    --accent: #60a5fa;
    --green: #4ade80;
    --red: #f87171;
    --orange: #fb923c;
    --sky: #38bdf8;
    --lime: #a3e635;
    --slate: #94a3b8;
    --purple: #c084fc;
    --font-mono: "SF Mono", "Cascadia Code", "Fira Code", Menlo, monospace;
    --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }

  body {
    font-family: var(--font-sans);
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* --- Header --- */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-sidebar);
    flex-shrink: 0;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header h1 {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
  }

  .connection-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--red);
    transition: background 0.3s;
  }

  .connection-dot.connected { background: var(--green); }

  .header-stats {
    display: flex;
    gap: 16px;
    font-size: 13px;
    color: var(--text-dim);
    font-family: var(--font-mono);
  }

  .header-stats span { display: flex; align-items: center; gap: 4px; }
  .stat-label { color: var(--text-muted); }

  /* --- Main layout --- */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* --- Sidebar --- */
  .sidebar {
    width: 260px;
    border-right: 1px solid var(--border);
    background: var(--bg-sidebar);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
  }

  .sidebar-header {
    padding: 12px 16px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
  }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .sidebar-item {
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text-dim);
    transition: background 0.15s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sidebar-item:hover { background: var(--bg-card); }
  .sidebar-item.active { background: var(--bg-card); color: var(--accent); }

  .sidebar-item .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    flex-shrink: 0;
  }

  .sidebar-date {
    padding: 8px 12px 4px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .session-id {
    font-family: var(--font-mono);
    font-size: 12px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* --- Timeline --- */
  .timeline-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .timeline-toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .timeline-toolbar select,
  .timeline-toolbar input {
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 13px;
    font-family: var(--font-sans);
  }

  .timeline-toolbar select { cursor: pointer; }
  .timeline-toolbar input { flex: 1; min-width: 0; }
  .timeline-toolbar input::placeholder { color: var(--text-muted); }

  .timeline {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    scroll-behavior: smooth;
  }

  .timeline::-webkit-scrollbar { width: 6px; }
  .timeline::-webkit-scrollbar-track { background: transparent; }
  .timeline::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* --- Event cards --- */
  .event-card {
    margin-bottom: 4px;
    border-radius: 6px;
    border: 1px solid transparent;
    transition: border-color 0.15s;
    overflow: hidden;
  }

  .event-card:hover { border-color: var(--border); }

  .event-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 12px;
    cursor: pointer;
    font-size: 13px;
    user-select: none;
  }

  .event-time {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-muted);
    flex-shrink: 0;
    width: 70px;
  }

  .agent-badge {
    font-size: 10px;
    font-weight: 600;
    padding: 1px 6px;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    flex-shrink: 0;
  }

  .agent-main { background: rgba(96, 165, 250, 0.15); color: var(--accent); }
  .agent-sub { background: rgba(251, 146, 60, 0.15); color: var(--orange); }

  .event-type {
    font-family: var(--font-mono);
    font-size: 12px;
    flex-shrink: 0;
  }

  .event-summary {
    color: var(--text-dim);
    font-size: 13px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
    min-width: 0;
  }

  .event-chevron {
    color: var(--text-muted);
    font-size: 10px;
    flex-shrink: 0;
    transition: transform 0.15s;
  }

  .event-card.expanded .event-chevron { transform: rotate(90deg); }

  .event-detail {
    display: none;
    padding: 0 12px 10px 90px;
    font-size: 13px;
    line-height: 1.5;
  }

  .event-card.expanded .event-detail { display: block; }

  .event-detail pre {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 8px 12px;
    font-family: var(--font-mono);
    font-size: 12px;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 300px;
    overflow-y: auto;
    color: var(--text-dim);
    margin: 4px 0;
  }

  .event-detail .detail-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 8px 0 4px;
  }

  .event-detail .detail-label:first-child { margin-top: 0; }

  /* Event type colors */
  .type-system .event-type { color: var(--slate); }
  .type-assistant .event-type { color: var(--sky); }
  .type-user .event-type { color: var(--lime); }
  .type-result .event-type { color: var(--green); }
  .type-result.is-error .event-type { color: var(--red); }

  .type-system .event-header { background: rgba(148, 163, 184, 0.04); }
  .type-assistant .event-header { background: rgba(56, 189, 248, 0.04); }
  .type-user .event-header { background: rgba(163, 230, 53, 0.04); }
  .type-result .event-header { background: rgba(74, 222, 128, 0.06); }
  .type-result.is-error .event-header { background: rgba(248, 113, 113, 0.06); }

  .error-text { color: var(--red); }
  .success-text { color: var(--green); }

  /* Tool name highlight */
  .tool-name {
    color: var(--sky);
    font-weight: 600;
  }

  /* Result summary */
  .result-stats {
    display: flex;
    gap: 16px;
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text-dim);
    padding: 4px 0;
  }

  .result-stats span { display: flex; align-items: center; gap: 4px; }

  /* Empty state */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-muted);
    gap: 8px;
  }

  .empty-state .icon { font-size: 32px; opacity: 0.5; }
  .empty-state .title { font-size: 15px; font-weight: 500; }
  .empty-state .desc { font-size: 13px; }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="connection-dot" id="connDot"></div>
    <h1>Jarvis Log Viewer</h1>
  </div>
  <div class="header-stats">
    <span><span class="stat-label">Cost:</span> $<span id="statCost">0.00</span></span>
    <span><span class="stat-label">Turns:</span> <span id="statTurns">0</span></span>
    <span><span class="stat-label">Events:</span> <span id="statEvents">0</span></span>
  </div>
</div>

<div class="main">
  <div class="sidebar">
    <div class="sidebar-header">Sessions</div>
    <div class="sidebar-content" id="sessionList">
      <div class="sidebar-item active" id="liveSession">
        <div class="dot"></div>
        <span>Live</span>
      </div>
    </div>
  </div>

  <div class="timeline-container">
    <div class="timeline-toolbar">
      <select id="filterType">
        <option value="all">All types</option>
        <option value="system">System</option>
        <option value="assistant">Assistant</option>
        <option value="user">User</option>
        <option value="result">Result</option>
      </select>
      <select id="filterAgent">
        <option value="all">All agents</option>
        <option value="main">Main</option>
      </select>
      <input type="text" id="searchInput" placeholder="Search events...">
    </div>
    <div class="timeline" id="timeline">
      <div class="empty-state" id="emptyState">
        <div class="icon">&#9678;</div>
        <div class="title">Waiting for events</div>
        <div class="desc">Send a message to Jarvis to see live events here</div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const timeline = document.getElementById("timeline");
  const emptyState = document.getElementById("emptyState");
  const connDot = document.getElementById("connDot");
  const statCost = document.getElementById("statCost");
  const statTurns = document.getElementById("statTurns");
  const statEvents = document.getElementById("statEvents");
  const filterType = document.getElementById("filterType");
  const filterAgent = document.getElementById("filterAgent");
  const searchInput = document.getElementById("searchInput");
  const sessionList = document.getElementById("sessionList");
  const liveSession = document.getElementById("liveSession");

  let events = [];        // events for current view
  let liveEvents = [];    // persists across view switches
  let liveCost = 0;
  let liveTurns = 0;
  let totalCost = 0;
  let totalTurns = 0;
  let autoScroll = true;
  let isLive = true;
  let knownAgents = new Set(["main"]);
  let liveAgents = new Set(["main"]);
  let ws = null;
  let reconnectDelay = 1000;

  function hideEmptyState() {
    var el = timeline.querySelector(".empty-state");
    if (el) el.style.display = "none";
  }

  // --- WebSocket ---
  function connect() {
    ws = new WebSocket("ws://" + location.host);

    ws.onopen = function() {
      connDot.classList.add("connected");
      reconnectDelay = 1000;
    };

    ws.onclose = function() {
      connDot.classList.remove("connected");
      setTimeout(connect, reconnectDelay);
      reconnectDelay = Math.min(reconnectDelay * 2, 10000);
    };

    ws.onerror = function() { ws.close(); };

    ws.onmessage = function(e) {
      var event;
      try { event = JSON.parse(e.data); } catch { return; }
      if (event.type === "connected") return;

      // Always store in liveEvents
      liveEvents.push(event);
      if (event.type === "result") {
        liveCost += event.total_cost_usd || 0;
        liveTurns += event.num_turns || 0;
      }
      if (event._agentName) liveAgents.add(event._agentName);

      // Only render if viewing live
      if (isLive) addEvent(event);
    };
  }

  connect();

  // --- Auto-scroll detection ---
  timeline.addEventListener("scroll", function() {
    var atBottom = timeline.scrollHeight - timeline.scrollTop - timeline.clientHeight < 50;
    autoScroll = atBottom;
  });

  // --- Event rendering ---
  function addEvent(event) {
    events.push(event);
    hideEmptyState();

    // Track agents for current view
    if (event._agentName && !knownAgents.has(event._agentName)) {
      knownAgents.add(event._agentName);
      updateAgentFilter();
    }

    // Update stats
    if (event.type === "result") {
      totalCost += event.total_cost_usd || 0;
      totalTurns += event.num_turns || 0;
      statCost.textContent = totalCost.toFixed(4);
      statTurns.textContent = totalTurns;
    }
    statEvents.textContent = events.length;

    var card = renderCard(event);
    if (card) {
      timeline.appendChild(card);
      applyFilters();
      if (autoScroll) timeline.scrollTop = timeline.scrollHeight;
    }
  }

  function renderCard(event) {
    var card = document.createElement("div");
    var typeClass = "type-" + event.type;
    card.className = "event-card " + typeClass;
    card.dataset.type = event.type;
    card.dataset.agent = event._agentName || "main";
    card.dataset.searchText = JSON.stringify(event).toLowerCase();

    if (event.type === "result" && event.is_error) {
      card.classList.add("is-error");
    }

    var time = event._timestamp ? new Date(event._timestamp).toLocaleTimeString() : "--:--:--";
    var agent = event._agentName || "main";
    var badgeClass = agent === "main" ? "agent-main" : "agent-sub";

    var summary = getSummary(event);
    var detail = getDetail(event);

    card.innerHTML =
      '<div class="event-header">' +
        '<span class="event-time">' + time + '</span>' +
        '<span class="agent-badge ' + badgeClass + '">' + escHtml(agent) + '</span>' +
        '<span class="event-type">' + getTypeLabel(event) + '</span>' +
        '<span class="event-summary">' + escHtml(summary) + '</span>' +
        '<span class="event-chevron">&#9654;</span>' +
      '</div>' +
      '<div class="event-detail">' + detail + '</div>';

    card.querySelector(".event-header").addEventListener("click", function() {
      card.classList.toggle("expanded");
    });

    return card;
  }

  function getTypeLabel(event) {
    if (event.type === "system") return "system/" + escHtml(event.subtype || "?");
    if (event.type === "assistant") {
      var content = event.message && event.message.content;
      if (content) {
        for (var i = 0; i < content.length; i++) {
          if (content[i].type === "tool_use") return '<span class="tool-name">tool_use</span>';
        }
      }
      return "text";
    }
    if (event.type === "user") return "tool_result";
    if (event.type === "result") return event.is_error ? "result (error)" : "result";
    return escHtml(event.type);
  }

  function getSummary(event) {
    if (event.type === "system" && event.subtype === "init") {
      return "model: " + (event.model || "?") + ", tools: " + (event.tools ? event.tools.length : 0);
    }
    if (event.type === "system") {
      return event.hook_name || event.subtype || "";
    }
    if (event.type === "assistant") {
      var content = event.message && event.message.content;
      if (!content) return "";
      for (var i = 0; i < content.length; i++) {
        if (content[i].type === "tool_use") {
          var input = content[i].input || {};
          var preview = "";
          if (content[i].name === "Bash" && input.command) preview = input.command;
          else if (content[i].name === "Task" && input.subagent_type) preview = "agent: " + input.subagent_type;
          else if (content[i].name === "Read" && input.file_path) preview = input.file_path;
          else if (content[i].name === "Write" && input.file_path) preview = input.file_path;
          else if (content[i].name === "Edit" && input.file_path) preview = input.file_path;
          else if (content[i].name === "Grep" && input.pattern) preview = "/" + input.pattern + "/";
          else if (content[i].name === "Glob" && input.pattern) preview = input.pattern;
          else preview = JSON.stringify(input).slice(0, 80);
          return content[i].name + ": " + preview;
        }
        if (content[i].type === "text") {
          return content[i].text.slice(0, 120);
        }
      }
      return "";
    }
    if (event.type === "user") {
      var msg = event.message && event.message.content;
      if (msg && msg.length > 0) {
        var text = contentText(msg[0].content || msg[0].text || "");
        if (msg[0].is_error) return "(error) " + text.slice(0, 100);
        return text.slice(0, 100);
      }
      return "";
    }
    if (event.type === "result") {
      return (event.num_turns || 0) + " turns, " +
        ((event.duration_ms || 0) / 1000).toFixed(1) + "s, $" +
        (event.total_cost_usd || 0).toFixed(4);
    }
    return "";
  }

  function getDetail(event) {
    if (event.type === "system" && event.subtype === "init") {
      return '<div class="detail-label">Session</div>' +
        '<pre>' + escHtml(event.session_id || "") + '</pre>' +
        '<div class="detail-label">Model</div>' +
        '<pre>' + escHtml(event.model || "") + '</pre>' +
        '<div class="detail-label">Tools (' + (event.tools ? event.tools.length : 0) + ')</div>' +
        '<pre>' + escHtml((event.tools || []).join(", ")) + '</pre>';
    }
    if (event.type === "system") {
      var parts = [];
      if (event.hook_name) parts.push('<div class="detail-label">Hook</div><pre>' + escHtml(event.hook_name) + '</pre>');
      if (event.output) parts.push('<div class="detail-label">Output</div><pre>' + escHtml(event.output) + '</pre>');
      if (event.exit_code !== undefined) parts.push('<div class="detail-label">Exit Code</div><pre>' + event.exit_code + '</pre>');
      return parts.join("") || '<pre>' + escHtml(JSON.stringify(event, null, 2)) + '</pre>';
    }
    if (event.type === "assistant") {
      var content = event.message && event.message.content;
      if (!content) return "";
      var parts = [];
      for (var i = 0; i < content.length; i++) {
        if (content[i].type === "text") {
          parts.push('<div class="detail-label">Text</div><pre>' + escHtml(content[i].text) + '</pre>');
        }
        if (content[i].type === "tool_use") {
          parts.push(
            '<div class="detail-label">Tool: ' + escHtml(content[i].name) + '</div>' +
            '<pre>' + escHtml(JSON.stringify(content[i].input, null, 2)) + '</pre>'
          );
        }
      }
      var usage = event.message && event.message.usage;
      if (usage) {
        parts.push(
          '<div class="detail-label">Tokens</div>' +
          '<pre>in: ' + (usage.input_tokens || 0) + ', out: ' + (usage.output_tokens || 0) +
          (usage.cache_read_input_tokens ? ', cache_read: ' + usage.cache_read_input_tokens : '') +
          (usage.cache_creation_input_tokens ? ', cache_create: ' + usage.cache_creation_input_tokens : '') +
          '</pre>'
        );
      }
      return parts.join("");
    }
    if (event.type === "user") {
      var parts = [];
      var msg = event.message && event.message.content;
      if (msg) {
        for (var i = 0; i < msg.length; i++) {
          var cls = msg[i].is_error ? ' class="error-text"' : '';
          var text = contentText(msg[i].content || msg[i].text || "");
          parts.push(
            '<div class="detail-label">' + (msg[i].is_error ? 'Error Result' : 'Result') + '</div>' +
            '<pre' + cls + '>' + escHtml(text) + '</pre>'
          );
        }
      }
      if (event.tool_use_result) {
        if (event.tool_use_result.stdout) {
          parts.push('<div class="detail-label">Stdout</div><pre>' + escHtml(event.tool_use_result.stdout) + '</pre>');
        }
        if (event.tool_use_result.stderr) {
          parts.push('<div class="detail-label">Stderr</div><pre class="error-text">' + escHtml(event.tool_use_result.stderr) + '</pre>');
        }
      }
      return parts.join("") || '<pre>' + escHtml(JSON.stringify(event, null, 2)) + '</pre>';
    }
    if (event.type === "result") {
      var parts = [];
      parts.push(
        '<div class="result-stats">' +
          '<span>Turns: ' + (event.num_turns || 0) + '</span>' +
          '<span>Duration: ' + ((event.duration_ms || 0) / 1000).toFixed(1) + 's</span>' +
          '<span>API: ' + ((event.duration_api_ms || 0) / 1000).toFixed(1) + 's</span>' +
          '<span>Cost: $' + (event.total_cost_usd || 0).toFixed(4) + '</span>' +
        '</div>'
      );
      if (event.result) {
        parts.push('<div class="detail-label">Result</div><pre>' + escHtml(event.result.slice(0, 2000)) + '</pre>');
      }
      if (event.permission_denials && event.permission_denials.length > 0) {
        parts.push(
          '<div class="detail-label error-text">Permission Denials</div>' +
          '<pre class="error-text">' + escHtml(JSON.stringify(event.permission_denials, null, 2)) + '</pre>'
        );
      }
      return parts.join("");
    }
    return '<pre>' + escHtml(JSON.stringify(event, null, 2)) + '</pre>';
  }

  function escHtml(s) {
    if (!s) return "";
    if (typeof s !== "string") s = JSON.stringify(s, null, 2);
    return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
  }

  // Extract display text from a content field that may be a string or array of {type,text} blocks
  function contentText(c) {
    if (!c) return "";
    if (typeof c === "string") return c;
    if (Array.isArray(c)) return c.map(function(b) { return b.text || ""; }).join("\n");
    return JSON.stringify(c);
  }

  // --- Filters ---
  function applyFilters() {
    var typeVal = filterType.value;
    var agentVal = filterAgent.value;
    var search = searchInput.value.toLowerCase();
    var cards = timeline.querySelectorAll(".event-card");
    for (var i = 0; i < cards.length; i++) {
      var card = cards[i];
      var show = true;
      if (typeVal !== "all" && card.dataset.type !== typeVal) show = false;
      if (agentVal !== "all" && card.dataset.agent !== agentVal) show = false;
      if (search && card.dataset.searchText.indexOf(search) === -1) show = false;
      card.style.display = show ? "" : "none";
    }
  }

  filterType.addEventListener("change", applyFilters);
  filterAgent.addEventListener("change", applyFilters);
  searchInput.addEventListener("input", applyFilters);

  function updateAgentFilter() {
    var current = filterAgent.value;
    filterAgent.innerHTML = '<option value="all">All agents</option>';
    knownAgents.forEach(function(name) {
      var opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      filterAgent.appendChild(opt);
    });
    filterAgent.value = current;
  }

  // --- Sidebar: load sessions ---
  function loadSessions() {
    fetch("/api/sessions")
      .then(function(r) { return r.json(); })
      .then(function(sessions) {
        // Group by date
        var byDate = {};
        sessions.forEach(function(s) {
          if (!byDate[s.date]) byDate[s.date] = [];
          byDate[s.date].push(s);
        });
        // Render (keep live item)
        var existing = sessionList.querySelectorAll(".history-item, .sidebar-date");
        existing.forEach(function(el) { el.remove(); });

        Object.keys(byDate).sort().reverse().forEach(function(date) {
          var dateEl = document.createElement("div");
          dateEl.className = "sidebar-date history-item";
          dateEl.textContent = date;
          sessionList.appendChild(dateEl);

          byDate[date].forEach(function(s) {
            var item = document.createElement("div");
            item.className = "sidebar-item history-item";
            item.innerHTML = '<span class="session-id">' + escHtml(s.sessionId.slice(0, 12)) + '...</span>';
            item.addEventListener("click", function() {
              loadHistoricalSession(s.date, s.sessionId);
              // Update active state
              sessionList.querySelectorAll(".sidebar-item").forEach(function(el) { el.classList.remove("active"); });
              item.classList.add("active");
            });
            sessionList.appendChild(item);
          });
        });
      })
      .catch(function() {});
  }

  // Load on startup and refresh periodically
  loadSessions();
  setInterval(loadSessions, 30000);

  // --- Rebuild timeline from an event array ---
  function renderAllEvents(eventList) {
    timeline.innerHTML = "";
    events = [];
    totalCost = 0;
    totalTurns = 0;
    knownAgents = new Set(["main"]);

    if (eventList.length === 0) {
      timeline.innerHTML = '<div class="empty-state"><div class="icon">&#9678;</div><div class="title">No events</div></div>';
    } else {
      eventList.forEach(function(event) { addEvent(event); });
    }
    updateAgentFilter();
  }

  // --- Load historical session ---
  function loadHistoricalSession(date, sessionId) {
    isLive = false;
    timeline.innerHTML = '<div class="empty-state"><div class="icon">&#9678;</div><div class="title">Loading...</div></div>';
    events = [];
    totalCost = 0;
    totalTurns = 0;
    knownAgents = new Set(["main"]);

    fetch("/api/session/" + date + "/" + sessionId)
      .then(function(r) {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      })
      .then(function(data) {
        renderAllEvents(data);
      })
      .catch(function(err) {
        timeline.innerHTML = '<div class="empty-state"><div class="title">Failed to load session</div><div class="desc">' + escHtml(String(err)) + '</div></div>';
      });
  }

  // --- Live mode ---
  liveSession.addEventListener("click", function() {
    isLive = true;
    sessionList.querySelectorAll(".sidebar-item").forEach(function(el) { el.classList.remove("active"); });
    liveSession.classList.add("active");

    // Restore live events
    if (liveEvents.length === 0) {
      timeline.innerHTML = '<div class="empty-state"><div class="icon">&#9678;</div><div class="title">Waiting for events</div><div class="desc">Send a message to Jarvis to see live events here</div></div>';
      events = [];
      totalCost = 0;
      totalTurns = 0;
      knownAgents = new Set(["main"]);
      statCost.textContent = "0.00";
      statTurns.textContent = "0";
      statEvents.textContent = "0";
      updateAgentFilter();
    } else {
      renderAllEvents(liveEvents);
      // Sync stats from live accumulators
      totalCost = liveCost;
      totalTurns = liveTurns;
      knownAgents = new Set(liveAgents);
      statCost.textContent = liveCost.toFixed(4);
      statTurns.textContent = liveTurns;
      statEvents.textContent = liveEvents.length;
      updateAgentFilter();
      autoScroll = true;
      timeline.scrollTop = timeline.scrollHeight;
    }
  });
})();
</script>

</body>
</html>
